<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Hub</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>
    <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Firebase Configuration
        const firebaseConfig = {
          apiKey: "AIzaSyCBN6opABavXAJCvCnRvghYU4E0faOM7ng",
          authDomain: "community-hub-saltproject.firebaseapp.com",
          projectId: "community-hub-saltproject",
          storageBucket: "community-hub-saltproject.firebasestorage.app",
          messagingSenderId: "1007010017446",
          appId: "1:1007010017446:web:06f371a8755fb509968467"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // [Icon components omitted for brevity]

        function CommunityHub() {
            const [residents, setResidents] = useState([]);
            const [messages, setMessages] = useState([]);
            const [selectedBuilding, setSelectedBuilding] = useState('');
            const [selectedZone, setSelectedZone] = useState('');
            const [viewMode, setViewMode] = useState('list');
            const [currentUser, setCurrentUser] = useState(null);
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [authMode, setAuthMode] = useState('signin');
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            const [showRegistrationForm, setShowRegistrationForm] = useState(false);
            const [showMessageModal, setShowMessageModal] = useState(false);
            const [messageRecipient, setMessageRecipient] = useState(null);
            const [messageText, setMessageText] = useState('');
            const [authData, setAuthData] = useState({ email:'', password:'', confirmPassword:'', name:'', zoneId:'', buildingId:'', unitNumber:'', phone:'' });
            const [formData, setFormData] = useState({ name:'', zoneId:'', buildingId:'', unitNumber:'', email:'', phone:'' });

            // Auth state listener
            useEffect(() => {
                const unsub = auth.onAuthStateChanged(async user => {
                    setLoading(true);
                    if (user) {
                        const userDoc = await db.collection('users').doc(user.uid).get();
                        if (userDoc.exists) {
                            setCurrentUser({ id: user.uid, ...userDoc.data() });
                            setIsAuthenticated(true);
                            await db.collection('users').doc(user.uid).update({ isOnline: true, lastSeen: firebase.firestore.FieldValue.serverTimestamp() });
                        }
                    } else {
                        setCurrentUser(null);
                        setIsAuthenticated(false);
                    }
                    setLoading(false);
                });
                return () => unsub();
            }, []);

            // Residents listener (unchanged)
            useEffect(() => {
                const unsubscribe = db.collection('users')
                    .onSnapshot(snapshot => {
                        const data = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                        data.sort((a,b) => a.zoneId.localeCompare(b.zoneId) || a.buildingId.localeCompare(b.buildingId) || (parseInt(a.unitNumber)-parseInt(b.unitNumber)));
                        setResidents(data);
                    });
                return () => unsubscribe();
            }, []);

            // Messages listener without orderBy
            useEffect(() => {
                if (!currentUser) return;
                const unsubscribe = db.collection('messages')
                    .where('participants','array-contains',currentUser.id)
                    .onSnapshot(snap => {
                        const data = snap.docs.map(d => ({ id:d.id, ...d.data() }));
                        data.sort((a,b)=>{
                            const ta = a.timestamp?.toMillis? a.timestamp.toMillis():0;
                            const tb = b.timestamp?.toMillis? b.timestamp.toMillis():0;
                            return tb-ta;
                        });
                        setMessages(data);
                    }, err=>{
                        console.error('Message listener error:',err);
                        setMessages([]);
                    });
                return () => unsubscribe();
            }, [currentUser]);

            // Updated send message handler
            const handleSendMessage = async () => {
                if (!messageText.trim() || !currentUser || !messageRecipient) {
                    console.warn('Cannot send:', { messageText, currentUser, messageRecipient });
                    return;
                }
                setLoading(true);
                setError('');
                try {
                    console.log('Sending message:', { from: currentUser.id, to: messageRecipient.id, text: messageText.trim() });
                    const docRef = await db.collection('messages').add({
                        fromId: currentUser.id,
                        fromName: currentUser.name,
                        toId: messageRecipient.id,
                        toName: messageRecipient.name,
                        message: messageText.trim(),
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        participants: [currentUser.id, messageRecipient.id],
                        read: false
                    });
                    console.log('Message saved, ID:', docRef.id);
                    setMessageText('');
                    setShowMessageModal(false);
                    setMessageRecipient(null);
                    alert(`Message sent to ${messageRecipient.name}!`);
                } catch(err) {
                    console.error('Error sending message:', err);
                    setError(err.message||'Error sending message');
                } finally {
                    setLoading(false);
                }
            };

            // Other handlers (signin, signup, signout, registration) unchanged …

            if (loading) {
                return <div className="min-h-screen flex items-center justify-center"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div></div>;
            }
            if (!isAuthenticated) {
                // Sign in/up UI …
                return <div>Please sign in …</div>;
            }

            return (
                <div className="min-h-screen p-6 bg-gradient-to-br from-blue-50 to-indigo-100">
                    {/* Main dashboard UI, filters, list/visual modes unchanged … */}

                    {/* Message Modal */}
                    {showMessageModal && messageRecipient && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white rounded-xl p-8 max-w-md w-full">
                                <h2 className="text-2xl font-bold mb-4">Send Message</h2>
                                {error && <p className="text-red-600 mb-2">{error}</p>}
                                <textarea
                                    value={messageText}
                                    onChange={e=>setMessageText(e.target.value)}
                                    className="w-full border p-2 mb-4" placeholder="Type your message…" rows={4}
                                />
                                <div className="flex gap-4">
                                    <button
                                        onClick={handleSendMessage}
                                        disabled={loading||!messageText.trim()}
                                        className="flex-1 bg-blue-600 text-white py-2 rounded disabled:opacity-50"
                                    >{loading? 'Sending…':'Send Message'}</button>
                                    <button onClick={()=>{setShowMessageModal(false);setMessageRecipient(null);setError('');}}
                                        className="flex-1 bg-gray-300 py-2 rounded"
                                    >Cancel</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Simple message list */}
                    <ul className="mt-6 space-y-2">
                        {messages.map(m=>(
                            <li key={m.id} className="p-2 border rounded">
                                <strong>{m.fromName}</strong>: {m.message}
                            </li>
                        ))}
                    </ul>
                </div>
            );
        }

        // React 18 mount
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<CommunityHub />);
    </script>
</body>
</html>

